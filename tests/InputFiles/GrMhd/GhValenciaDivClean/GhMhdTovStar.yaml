# Distributed under the MIT License.
# See LICENSE.txt for details.

Executable: EvolveGhValenciaDivCleanTovStar
Testing:
  Check: parse;execute
  Timeout: 8
  Priority: High
ExpectedOutput:
  - GhMhdTovStarVolume0.h5
  - GhMhdTovStarReductions.h5

---

ResourceInfo:
  AvoidGlobalProc0: false
  Singletons: Auto

Evolution:
  InitialTime: 0.0
  InitialTimeStep: 0.0001
  TimeStepper:
    AdamsMoultonPc:
      Order: 3

PhaseChangeAndTriggers:
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 1000
          Offset: 5
    PhaseChanges:
      - VisitAndReturn(LoadBalancing)

AnalyticSolution: &InitialData
  TovStar:
    CentralDensity: 1.28e-3
    EquationOfState:
        PolytropicFluid:
            PolytropicConstant: 100.0
            PolytropicExponent: 2.0
    Coordinates: Schwarzschild

# Note: this domain is chosen so that we only need to simulate the interior
# of the star
DomainCreator:
  Brick:
    LowerBound: [-5.0, -5.0, -5.0]
    UpperBound: [5.0, 5.0, 5.0]
    InitialRefinement: [1, 1, 1]
    InitialGridPoints: [3, 3, 3]
    TimeDependence: None
    BoundaryConditionInX:
      DirichletAnalytic:
    BoundaryConditionInY:
      DirichletAnalytic:
    BoundaryConditionInZ:
      DirichletAnalytic:

VariableFixing:
  FixConservatives:
    CutoffD: &CutoffD 1.0e-12
    MinimumValueOfD: &MinimumD 1.0e-12
    CutoffYe: 0.0
    MinimumValueOfYe: 0.0
    SafetyFactorForB: 1.0e-12
    SafetyFactorForS: 1.0e-12
    SafetyFactorForSCutoffD: 1.0e-12
    SafetyFactorForSSlope: 0.0
  FixToAtmosphere:
    DensityOfAtmosphere: 1.0e-12
    DensityCutoff: 1.0e-12
    TransitionDensityCutoff: 1.0e-11
    MaxVelocityMagnitude: 1.0e-4
    MaxThermalSpecificEnergy: 1.0e4
  LimitLorentzFactor:
    MaxDensityCutoff: 1.0e-12
    LorentzFactorCap: 1.0

PrimitiveFromConservative:
  CutoffDForInversion: *CutoffD
  DensityWhenSkippingInversion: *MinimumD
  KastaunMaxLorentzFactor: 10.0

EvolutionSystem:
  ValenciaDivClean:
    DampingParameter: 0.0
  GeneralizedHarmonic:
    GaugeCondition:
      AnalyticChristoffel:
        AnalyticPrescription: *InitialData
    DampingFunctionGamma0:
      GaussianPlusConstant:
        Constant: 1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma1:
      GaussianPlusConstant:
        Constant: -1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]
    DampingFunctionGamma2:
      GaussianPlusConstant:
        Constant: 1.0
        Amplitude: 0.0
        Width: 1.0
        Center: [0.0, 0.0, 0.0]


SpatialDiscretization:
  BoundaryCorrection:
    ProductUpwindPenaltyAndRusanov:
      UpwindPenalty:
      Rusanov:
  DiscontinuousGalerkin:
    Formulation: StrongInertial
    Quadrature: GaussLobatto
    Subcell:
      RdmpDelta0: 1.0e-7
      RdmpEpsilon: 1.0e-3
      PerssonExponent: 4.0
      InitialData:
        RdmpDelta0: 1.0e-7
        RdmpEpsilon: 1.0e-3
        PerssonExponent: 4.0
      AlwaysUseSubcells: true
      SubcellToDgReconstructionMethod: DimByDim
      UseHalo: false
      OnlyDgBlocksAndGroups: None
      FiniteDifferenceDerivativeOrder: 2
    TciOptions:
      MinimumValueOfD: 1.0e-20
      MinimumValueOfYe: 1.0e-20
      MinimumValueOfTildeTau: 1.0e-50
      AtmosphereDensity: 1.01e-15
      SafetyFactorForB: 1.0e-12
      MagneticFieldCutoff: DoNotCheckMagneticField
  SubcellSolver:
    Reconstructor:
      MonotonisedCentralPrim:
    FilterOptions:
      SpacetimeDissipation: 0.1

Filtering:
  ExpFilter0:
    Alpha: 36
    HalfPower: 64
    Enable: true
    BlocksToFilter: All


EventsAndTriggers:
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 5
          Offset: 0
    Events:
      - ChangeSlabSize:
          DelayChange: 5
          StepChoosers:
            - Cfl:
                SafetyFactor: 0.6
            - Increase:
                Factor: 1.5
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 1
          Offset: 0
    Events:
      - ObserveNorms:
          SubfileName: Errors
          TensorsToObserve:
            - Name: Error(SpacetimeMetric)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Pi)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Phi)
              NormType: L2Norm
              Components: Sum
            - Name: Error(RestMassDensity)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpecificInternalEnergy)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpatialVelocity)
              NormType: L2Norm
              Components: Sum
            - Name: Error(MagneticField)
              NormType: L2Norm
              Components: Sum
            - Name: Error(DivergenceCleaningField)
              NormType: L2Norm
              Components: Sum
            - Name: Error(LorentzFactor)
              NormType: L2Norm
              Components: Sum
            - Name: Error(Pressure)
              NormType: L2Norm
              Components: Sum
            - Name: Error(SpecificEnthalpy)
              NormType: L2Norm
              Components: Sum
  - Trigger:
      Slabs:
        EvenlySpaced:
          Interval: 2
          Offset: 0
    Events:
      - ObserveFields:
          SubfileName: VolumeData
          VariablesToObserve:
            - SpacetimeMetric
            - RestMassDensity
            - Pressure
            - MagneticField
            - PointwiseL2Norm(GaugeConstraint)
          InterpolateToMesh: None
          CoordinatesFloatingPointType: Double
          FloatingPointTypes: [Double, Double, Double, Double, Double]
  - Trigger:
      Slabs:
        Specified:
          Values: [3]
    Events:
      - Completion

InterpolationTargets:
  BondiSachsInterpolation:
    LMax: 16
    Radius: [1]
    Center: [0, 0, 0]
    AngularOrdering: Cce

Cce:
  BondiSachsOutputFilePrefix: "BondiSachs"

Observers:
  VolumeFileName: "GhMhdTovStarVolume"
  ReductionFileName: "GhMhdTovStarReductions"

Interpolator:
  DumpVolumeDataOnFailure: false

EventsAndDenseTriggers:

EventsRunAtCleanup:
  ObservationValue: -1000.0
  Events:
